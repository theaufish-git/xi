apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "release.name" . }}
  labels:
    app: {{ include "release.name" . }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ include "release.name" . }}
  template:
    metadata:
      labels:
        app: {{ include "release.name" . }}
    spec:
      containers:
      - name: connect
        image: {{ coalesce  .Values.xi.connect.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.xi.connect.revision .Values.xi.revision .Values.revision }}
        imagePullPolicy: IfNotPresent
        command:
        - xi_connect
        env:
        {{- include "container.env.default" . | nindent 8 }}
        ports:
        {{- include "container.port" .Values.xi.connect.ports.auth | nindent 8 }}
        {{- include "container.port" .Values.xi.connect.ports.data | nindent 8 }}
        {{- include "container.port" .Values.xi.connect.ports.view | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      - name: map
        image: {{ coalesce  .Values.xi.map.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.xi.map.revision .Values.xi.revision .Values.revision }}
        imagePullPolicy: IfNotPresent
        command:
        - xi_map
        env:
        {{- include "container.env.default" . | nindent 8 }}
        ports:
        {{- include "container.port" .Values.xi.map.ports.map | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-losmeshes
          mountPath: /opt/xi/losmeshes
        - name: {{ include "release.name" . }}-navmeshes
          mountPath: /opt/xi/navmeshes
        - name: {{ include "release.name" . }}-scripts
          mountPath: /opt/xi/scripts
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      - name: search
        image: {{ coalesce .Values.xi.search.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.xi.search.revision .Values.xi.revision .Values.revision }}
        imagePullPolicy: IfNotPresent
        command:
        - xi_search
        env:
        {{- include "container.env.default" . | nindent 8 }}
        ports:
        {{- include "container.port" .Values.xi.search.ports.search | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      - name: world
        image: {{ coalesce  .Values.xi.world.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.xi.world.revision .Values.xi.revision .Values.revision }}
        imagePullPolicy: IfNotPresent
        command:
        - xi_world
        env:
        {{- include "container.env.default" . | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-scripts
          mountPath: /opt/xi/scripts
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      initContainers:
      - name: configure
        image: {{ coalesce  .Values.init.configure.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.init.configure.revision .Values.xi.revision .Values.revision }}-config
        imagePullPolicy: IfNotPresent
        command:
        - sh
        args:
        - -c
        - |
          mkdir -p /opt/xi/settings/default && \
          xi-config -o /opt/xi/settings -p xi && \
          xi-config -o /opt/xi/settings/default -p xi
        env:
        {{- include "container.env.default" . | nindent 8 }}
        {{- include "container.env.secrets" .Values.init.configure.secrets | nindent 8 }}
        envFrom:
        - configMapRef:
            name: {{ include "release.name" . }}
        volumeMounts:
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      - name: meshes
        image: {{ coalesce  .Values.init.meshes.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.init.meshes.revision .Values.xi.revision .Values.revision }}-meshes
        imagePullPolicy: IfNotPresent
        command:
        - bash
        args:
        - -c
        - |
          cp /opt/xi/losmeshes/* /opt/xi/server/losmeshes && \
          cp /opt/xi/navmeshes/* /opt/xi/server/navmeshes
        env:
        {{- include "container.env.default" . | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-losmeshes
          mountPath: /opt/xi/server/losmeshes
        - name: {{ include "release.name" . }}-navmeshes
          mountPath: /opt/xi/server/navmeshes
      - name: scripts
        image: {{ coalesce  .Values.init.scripts.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.init.scripts.revision .Values.xi.revision .Values.revision }}-scripts
        imagePullPolicy: IfNotPresent
        command:
        - bash
        args:
        - -c
        - "cp -r /opt/xi/scripts/* /opt/xi/server/scripts;"
        env:
        {{- include "container.env.default" . | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-scripts
          mountPath: /opt/xi/server/scripts
      volumes:
      - name: {{ include "release.name" . }}-nil
        emptyDir: {}
      - name: {{ include "release.name" . }}-losmeshes
        emptyDir: {}
      - name: {{ include "release.name" . }}-navmeshes
        emptyDir: {}
      - name: {{ include "release.name" . }}-scripts
        emptyDir: {}
      - name: {{ include "release.name" . }}-settings
        emptyDir: {}
{{- if .Values.sql.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "release.name.sql" $ }}
  labels:
    app: {{ include "release.name.sql" $ }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ include "release.name.sql" $ }}
  template:
    metadata:
      labels:
        app: {{ include "release.name.sql" $ }}
    spec:
      containers:
      - name: sql
        image: {{ default .Values.repository .Values.sql.repository }}:{{ default .Values.revision .Values.sql.revision }}-sql
        imagePullPolicy: IfNotPresent
        env:
        {{- include "container.env.default" .Values.sql | nindent 8 }}
        {{- include "container.env.secrets" .Values.sql.secrets | nindent 8 }}
        envFrom:
        - configMapRef:
            name: {{ include "release.name" . }}-sql
        ports:
        {{- include "container.port" .Values.sql.ports.sql | nindent 8 }}
        volumeMounts:
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
      initContainers:
      - name: configure
        image: {{ coalesce  .Values.init.configure.repository .Values.xi.repository .Values.repository }}:{{ coalesce  .Values.init.configure.revision .Values.xi.revision .Values.revision }}-config
        imagePullPolicy: IfNotPresent
        command:
        - sh
        args:
        - -c
        - |
          mkdir -p /opt/xi/settings/default && \
          xi-config -o /opt/xi/settings -p xi && \
          xi-config -o /opt/xi/settings/default -p xi
        env:
        {{- include "container.env.default" . | nindent 8 }}
        {{- include "container.env.secrets" .Values.init.configure.secrets | nindent 8 }}
        envFrom:
        - configMapRef:
            name: {{ include "release.name" . }}
        - configMapRef:
            name: {{ include "release.name" . }}-sql
        volumeMounts:
        - name: {{ include "release.name" . }}-settings
          mountPath: /opt/xi/settings
        - name: {{ include "release.name" . }}-sql-backups
          mountPath: /opt/xi/sql/backups
        - name: {{ include "release.name" . }}-sql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: {{ include "release.name" . }}-settings
        emptyDir: {}
      - name: {{ include "release.name" . }}-sql-backups
        hostPath:
          path: {{ .Values.sql.dirs.backups }}
          type: DirectoryOrCreate
      - name: {{ include "release.name" . }}-sql-storage
        hostPath:
          path: {{ .Values.sql.dirs.storage }}
          type: DirectoryOrCreate
{{- end }}